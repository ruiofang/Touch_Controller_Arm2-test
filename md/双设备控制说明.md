# 双Touch设备双机械臂控制系统

## 项目概述

本项目是一个基于OpenHaptics的双Touch设备控制双机械臂系统，支持同时使用两个Touch设备分别控制两个机械臂，实现精确的位置和姿态控制。

## 核心特性

- **双设备支持**: 同时支持两个Touch设备独立工作
- **双机械臂控制**: 每个Touch设备控制一个对应的机械臂
- **实时触觉反馈**: 提供高质量的力反馈和触觉体验
- **容错设计**: 机械臂连接失败时Touch设备仍可正常提供触觉反馈
- **灵活配置**: 支持通过配置文件调整所有控制参数

## 设备配置

### 支持的设备类型

根据OpenHaptics官方标准，本系统支持以下设备配置：

#### 标准设备名称 (推荐)
- **设备1**: `PHANToM 1` - 对应机械臂1
- **设备2**: `PHANToM 2` - 对应机械臂2

#### 备用设备名称
如果标准名称不可用，系统会自动尝试以下备用名称：
- **设备1备用**: `Default Device` (系统默认设备)
- **设备2备用**: `Device1`, `PHANTOM 2`, `PHANToM Device 2`

### 设备名称配置

在`config.ini`文件中可以自定义设备名称：

```ini
[device_names]
device1_primary = PHANToM 1
device1_fallback = Default Device
device2_primary = PHANToM 2
device2_fallback = Device1,PHANTOM 2,PHANToM Device 2
```

**配置说明**:
- `device1_primary`: 设备1的首选名称
- `device1_fallback`: 设备1的备用名称
- `device2_primary`: 设备2的首选名称
- `device2_fallback`: 设备2的备用名称列表（逗号分隔）

### 设备发现流程

程序启动时按以下顺序搜索设备：

1. **步骤1**: 尝试连接`device1_primary`指定的设备作为设备1
2. **步骤2**: 如果失败，尝试`device1_fallback`指定的备用设备
3. **步骤3**: 尝试连接`device2_primary`指定的设备作为设备2
4. **步骤4**: 如果失败，依次尝试`device2_fallback`列表中的所有设备
5. **步骤5**: 配置回调函数并启动触觉调度器

### 常见设备配置场景

#### 场景1: 标准双PHANToM设备
```ini
[device_names]
device1_primary = PHANToM 1
device2_primary = PHANToM 2
```

#### 场景2: 一个PHANToM + 一个Touch设备
```ini
[device_names]
device1_primary = PHANToM 1
device2_primary = Touch Device
device2_fallback = Device1,PHANTOM 2
```

#### 场景3: 自定义设备名称
```ini
[device_names]
device1_primary = MyTouch1
device1_fallback = PHANToM 1,Default Device
device2_primary = MyTouch2  
device2_fallback = Device1,PHANTOM 2
```

## 控制映射

### 设备控制分配

| 设备 | 按钮1 | 按钮2 | 控制目标 |
|------|-------|-------|----------|
| 设备1 | 机械臂1位置姿态 | 机械臂1夹抓 | 机械臂1 |
| 设备2 | 机械臂2位置姿态 | 机械臂2夹抓 | 机械臂2 |

### 坐标映射关系

**位置映射**：
- 触觉设备 X轴 → 机械臂 X轴
- 触觉设备 Y轴 → 机械臂 Y轴  
- 触觉设备 Z轴 → 机械臂 Z轴

**姿态映射**：
- 触觉设备 RX轴 → 机械臂 -RX轴（取反）
- 触觉设备 RY轴 → 机械臂 -RY轴（取反）
- 触觉设备 RZ轴 → 机械臂 RZ轴

### 控制参数

每个设备都有独立的控制参数，可在配置文件中调整：

```ini
[device1]
position_scale = 1240.578978    # 位置映射系数
rotation_scale = 0.774841       # 姿态映射系数
spring_stiffness = 0.2          # 弹簧刚度

[device2]  
position_scale = 1000.0
rotation_scale = 2.0
spring_stiffness = 0.2
```

## 机械臂配置

### 连接参数

```ini
[robot1]
ip = 192.168.10.19             # 机械臂1的IP地址
port = 8080                    # 机械臂1的端口

[robot2]
ip = 192.168.10.18             # 机械臂2的IP地址  
port = 8080                    # 机械臂2的端口
```

### 坐标系配置

```ini
[system]
teach_frame_type = 1           # 0=基坐标系, 1=工具坐标系
tool_coordinate_name = Arm_Tip # 工具坐标系名称
debug_frequency = 50           # 调试信息显示频率
control_frequency = 10         # 控制命令发送间隔(ms)
```

## 操作说明

### 键盘控制

| 按键 | 功能 | 说明 |
|------|------|------|
| `1` | 选择设备1 | 后续参数调整针对设备1 |
| `2` | 选择设备2 | 后续参数调整针对设备2 |
| `+`/`-` | 调整位置映射 | 增大/减小当前设备的位置映射系数 |
| `[`/`]` | 调整姿态映射 | 增大/减小当前设备的姿态映射系数 |
| `{`/`}` | 调整弹簧刚度 | 增大/减小当前设备的弹簧刚度 |
| `s` | 查询状态 | 显示当前选择设备的机械臂状态 |
| `c` | 保存配置 | 保存当前设备的配置到文件 |
| `f` | 切换坐标系 | 切换基坐标系/工具坐标系 |
| `q` | 退出程序 | 自动保存所有配置并退出 |

### 触觉设备操作

**设备1操作**：
- 按钮1：按住拖动控制机械臂1的位置和姿态
- 按钮2：切换机械臂1夹抓的开合状态

**设备2操作**：
- 按钮1：按住拖动控制机械臂2的位置和姿态  
- 按钮2：切换机械臂2夹抓的开合状态

## 容错功能

### 连接失败处理

系统具有完善的容错机制：

1. **Touch设备连接失败**: 程序会尝试备用设备名称，如果仍失败则使用单设备模式
2. **机械臂连接失败**: Touch设备仍可正常工作，提供纯触觉反馈模式
3. **部分连接成功**: 系统支持混合模式，成功连接的部分正常工作

### 运行模式

- **完全控制模式**: 两个Touch设备和两个机械臂都连接成功
- **混合模式**: 部分设备连接成功，可正常使用已连接的设备
- **纯触觉模式**: 机械臂全部连接失败，Touch设备仅提供触觉反馈

### 错误提示

程序会提供详细的错误信息和解决建议：
- 设备未找到时显示尝试的设备名称
- 机械臂连接失败时提供网络检查建议
- 实时显示每个设备和机械臂的连接状态

## 故障排除

### 常见问题

**1. Touch设备无法识别**
```
解决方案：
- 检查设备是否正确连接到USB端口
- 确认Touch_Setup程序已正确配置设备
- 验证设备名称是否与config.ini中的配置匹配
- 尝试运行Touch_Diagnostic检查设备状态
```

**2. 机械臂连接超时**
```
解决方案：
- 检查网络连接和IP地址配置
- 确认机械臂已开机并处于就绪状态
- 验证防火墙设置是否阻止连接
- 尝试ping机械臂IP地址确认网络通讯
```

**3. 触觉反馈异常**
```
解决方案：
- 调整弹簧刚度参数 (spring_stiffness)
- 检查位置和姿态映射系数是否合理
- 确认设备校准是否正确
- 重启程序重新初始化设备
```

**4. 坐标映射不正确**
```
解决方案：
- 确认坐标系类型设置 (teach_frame_type)
- 检查工具坐标系名称配置
- 调整位置和姿态映射系数
- 使用键盘快捷键实时调整参数
```

### 调试信息

程序提供详细的调试信息帮助定位问题：
- 设备初始化过程的每个步骤
- TCP连接状态和数据传输
- 触觉反馈计算过程
- 机械臂响应状态

可通过调整`debug_frequency`参数控制调试信息的显示频率。

## 技术特性

### 性能优化

- **高频控制**: 100Hz触觉更新频率，确保流畅的力反馈
- **异步通信**: TCP命令异步发送，避免阻塞触觉循环
- **缓冲区管理**: 定期清理TCP接收缓冲区，防止数据积压
- **力限制**: 自动限制反馈力大小，保护设备和用户安全

### 协议支持

- **OpenHaptics**: 完全兼容OpenHaptics 3.4标准
- **实曼机械臂**: 支持实曼机械臂的TCP JSON协议
- **配置管理**: INI格式配置文件，易于编辑和管理

### 扩展性

- **模块化设计**: 各个组件独立，易于扩展和维护
- **配置驱动**: 通过配置文件支持不同的设备和机械臂
- **标准接口**: 基于OpenHaptics标准，易于集成其他触觉设备

## 编译方法

```bash
# 方法1: 分步编译
gcc -c conio.c -o conio.o
g++ -o Touch_Controller_Arm Touch_Controller_Arm.cpp conio.o \
    -I./OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/include \
    -L./OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/lib \
    -lHD -lHDU -lrt -lpthread -lncurses -std=c++11

# 方法2: 使用Makefile
make

# 方法3: 使用CMake
mkdir build && cd build
cmake .. && make -j$(nproc)
```

## 运行方法

```bash
# 确保OpenHaptics驱动已安装
sudo ./Touch_Controller_Arm

# 或使用启动脚本
./启动双机械臂控制.sh
```

## 设备检测逻辑

程序会按以下顺序尝试初始化设备：

1. **设备1**: 使用 `HD_DEFAULT_DEVICE` (通常是第一个检测到的设备)
2. **设备2**: 依次尝试:
   - `"Device1"`
   - `"PHANTOM 2"`
   - `"PHANToM 2"`

如果只检测到一个设备，程序将继续运行但只能控制一个机械臂。

## 状态提示说明

### 🔗 连接成功提示
```
=== 开始新的拖动控制 ===
步骤1: 记录触觉设备锚点位置和姿态
步骤2: 获取机械臂当前真实位姿作为锚点...
步骤3: 成功设置机械臂锚点位姿: [x, y, z, rx, ry, rz]
=== 拖动控制已激活 ===
```

### 🎮 触觉反馈模式提示
```
=== 触觉反馈模式激活 ===
[device1] 机械臂未连接，启用纯触觉反馈模式
  触觉设备锚点: [x, y, z] (X,Y,Z)
🎮 您可以移动设备体验触觉反馈，但机械臂不会移动
=== 触觉反馈模式已激活 ===
```

### ⚠️ 机械臂连接失败提示
```
⚠️  警告: 无法连接到任何机械臂！
🎮 Touch设备仍可正常工作，仅提供触觉反馈功能
📡 机械臂控制功能将被禁用，但所有其他功能正常
🔧 请检查网络连接和机械臂状态，然后重启程序以启用机械臂控制
```

## 坐标映射说明

程序内部通过重新排列原始坐标实现直观的坐标对应：
- **位置映射**: 完全对应 (X→X, Y→Y, Z→Z)
- **姿态映射**: RX和RY取反以匹配机械臂控制逻辑

这种映射方式确保操作者的直觉运动与机械臂运动完全一致。

## 技术架构

### 类结构
- **ArmController**: TCP通信和机械臂控制
- **TouchArmController**: 触觉设备到机械臂的映射控制
- **ConfigLoader**: 配置文件管理

### 容错机制
- 机械臂连接状态实时检测
- 智能模式切换（控制模式 ↔ 触觉反馈模式）
- 用户友好的错误提示
- 程序稳定性保证

### 回调机制
- 每个设备独立的回调函数 (`device1Callback`, `device2Callback`)
- 实时力反馈计算和应用
- 异步控制命令发送 (100Hz频率)

### 内存管理
- 使用智能指针管理对象生命周期
- 程序退出时自动清理所有资源
- 配置自动保存机制

## 高级功能

### 实时参数调整
- 位置映射系数: 控制触觉设备移动到机械臂移动的比例
- 姿态映射系数: 控制触觉设备旋转到机械臂旋转的比例
- 弹簧刚度: 控制触觉反馈的力度大小

### 多坐标系支持
- 基坐标系: 稳定的控制体验
- 工具坐标系: 更直观的操作感受

### 调试功能
- 详细的TCP通信日志
- 实时状态查询
- 参数变化实时显示

## 使用建议

### 🎯 最佳实践
1. **首次运行**: 先确保至少一个机械臂能连接成功
2. **网络配置**: 使用稳定的有线网络连接
3. **参数调整**: 从默认值开始，逐步调整到舒适的操作感受
4. **安全操作**: 始终在安全的工作空间内操作

### 🔧 故障恢复
1. **连接中断**: 程序自动切换到触觉反馈模式，重启程序可重新尝试连接
2. **设备异常**: 检查USB连接和驱动状态
3. **参数异常**: 使用键盘快捷键重新调整或删除配置文件使用默认值

### 📊 性能提示
- 触觉反馈频率: 1000Hz (固定)
- 机械臂控制频率: 可配置 (默认100Hz)
- 调试信息频率: 可配置 (默认每50次显示一次) 