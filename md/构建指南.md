# 双Touch设备双机械臂控制系统 - 构建指南

## 概述

本项目提供了三种编译方式：**CMake**（推荐）、**传统Makefile** 和 **手动编译**。

## 🚀 方式1: CMake构建（推荐）

### 优点
- 现代化的构建系统
- 自动检测依赖
- 跨平台支持
- 详细的配置检查

### 前置要求
```bash
# 安装CMake (版本3.10+)
sudo apt update
sudo apt install cmake build-essential

# 安装依赖库
sudo apt install libncurses5-dev
```

### 构建步骤

#### 1. 配置项目
```bash
# 创建构建目录
mkdir build
cd build

# 配置项目
cmake ..
```

#### 2. 编译程序
```bash
# 编译 (使用所有CPU核心)
make -j$(nproc)

# 或者使用cmake命令
cmake --build . --parallel
```

#### 3. 运行程序
```bash
# 从构建目录运行
make run

# 或者直接运行
cd ..
./Touch_Controller_Arm
```

### CMake常用命令

```bash
# 检查配置
make check-config

# 清理编译文件
make clean

# 完全清理
make clean-all

# 安装到系统
sudo make install

# 创建软件包
make package
```

### 不同构建类型

```bash
# Debug版本
cmake -DCMAKE_BUILD_TYPE=Debug ..
make

# Release版本 (默认)
cmake -DCMAKE_BUILD_TYPE=Release ..
make

# 指定自定义OpenHaptics路径
cmake -DOPENHAPTICS_ROOT_DIR=/custom/path/to/openhaptics ..
```

## 🔧 方式2: 传统Makefile

### 优点
- 简单直观
- 无需额外工具
- 丰富的预定义目标

### 构建步骤

#### 1. 检查环境
```bash
make check
```

#### 2. 编译程序
```bash
# 默认编译
make

# 或者显式调用
make all
```

#### 3. 运行程序
```bash
make run
```

### Makefile常用目标

```bash
# 显示帮助
make help

# 编译调试版本
make debug

# 编译发布版本
make release

# 测试编译
make test-compile

# 清理文件
make clean

# 检查环境
make check

# 安装到系统
sudo make install

# 卸载
sudo make uninstall

# 创建软件包
make package

# 代码格式化
make format
```

## 🛠️ 方式3: 手动编译

### 适用场景
- 快速测试
- 自定义编译选项
- 学习编译过程

### 步骤

#### 1. 编译conio模块
```bash
gcc -c conio.c -o conio.o
```

#### 2. 编译主程序
```bash
g++ -o Touch_Controller_Arm Touch_Controller_Arm.cpp conio.o \
    -I./OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/include \
    -L./OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/lib \
    -lHD -lHDU -lrt -lpthread -lncurses -std=c++11
```

#### 3. 运行程序
```bash
./Touch_Controller_Arm
```

## 🧪 验证构建

### 1. 检查可执行文件
```bash
# 检查文件是否存在
ls -la Touch_Controller_Arm

# 检查文件权限
file Touch_Controller_Arm

# 检查依赖库
ldd Touch_Controller_Arm
```

### 2. 快速测试
```bash
# 显示版本信息 (如果支持)
./Touch_Controller_Arm --version 2>/dev/null || echo "程序已生成"

# 检查配置文件
cat config.ini
```

## 🐛 故障排除

### 常见问题1: OpenHaptics库未找到
```
错误: HD库未找到！路径: ./OpenHaptics/...
```

**解决方案:**
```bash
# 检查OpenHaptics目录
ls -la OpenHaptics/

# 检查库文件
ls -la OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/lib/

# 如果路径不同，修改CMakeLists.txt或Makefile中的路径
```

### 常见问题2: ncurses库未找到
```
错误: /usr/bin/ld: cannot find -lncurses
```

**解决方案:**
```bash
# Ubuntu/Debian
sudo apt install libncurses5-dev

# CentOS/RHEL
sudo yum install ncurses-devel

# 或者使用ncurses6
sudo apt install libncurses-dev
```

### 常见问题3: 编译器版本过低
```
错误: C++11特性不支持
```

**解决方案:**
```bash
# 检查编译器版本
g++ --version

# 升级编译器 (Ubuntu)
sudo apt install gcc-7 g++-7

# 或者使用clang
sudo apt install clang
export CXX=clang++
```

### 常见问题4: 权限问题
```
错误: 无法初始化触觉设备
```

**解决方案:**
```bash
# 使用root权限运行
sudo ./Touch_Controller_Arm

# 或者添加用户到相应组
sudo usermod -a -G dialout $USER
# 注销重新登录使生效
```

## 📊 性能优化

### 编译优化选项
```bash
# 最大优化 (Release)
make release
# 或者手动指定
g++ -O3 -DNDEBUG -march=native ...

# 调试信息 (Debug)
make debug
# 或者手动指定
g++ -g -O0 -DDEBUG ...
```

### 并行编译
```bash
# Makefile并行编译
make -j$(nproc)

# CMake并行编译
cmake --build . --parallel $(nproc)
```

## 🔄 持续集成

### GitHub Actions示例
```yaml
name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install cmake build-essential libncurses5-dev
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --parallel
    
    - name: Test
      run: make -C build check-config
```

## 📦 部署

### 系统安装
```bash
# CMake方式
cd build
sudo make install

# Makefile方式
sudo make install
```

### 创建软件包
```bash
# 使用CMake
cd build
make package

# 使用Makefile
make package
```

### Docker部署
```dockerfile
FROM ubuntu:20.04

RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    libncurses5-dev \
    && rm -rf /var/lib/apt/lists/*

COPY . /app
WORKDIR /app

RUN cmake -B build -DCMAKE_BUILD_TYPE=Release
RUN cmake --build build --parallel

CMD ["./Touch_Controller_Arm"]
```

## 📋 构建检查清单

- [ ] OpenHaptics库存在且路径正确
- [ ] 系统依赖库已安装 (ncurses, pthread)
- [ ] 编译器支持C++11
- [ ] 配置文件存在或使用默认配置
- [ ] 有足够的磁盘空间
- [ ] 网络连接正常 (用于机械臂通信)
- [ ] 触觉设备已连接且驱动正常

## 🎯 快速开始

**最简单的构建方式:**
```bash
# 1. 检查环境
make check

# 2. 编译运行
make run
```

**推荐的构建方式:**
```bash
# 1. 使用CMake
mkdir build && cd build
cmake .. && make -j$(nproc)

# 2. 运行程序
make run
``` 