# 双Touch设备控制器使用说明

## ⚠️ 重要更新：已升级为双机械臂控制系统

**新功能**：本项目现已升级为**双Touch设备双机械臂控制系统**！
- ✅ 支持两个Touch设备分别控制两个机械臂
- ✅ 独立的按钮控制映射 (位置姿态 + 夹抓控制)
- ✅ 实时TCP通信和JSON协议
- ✅ 独立的参数配置和调整
- ✅ 完整的坐标映射系统

**新程序文件**：`Touch_Controller_Arm.cpp` (主控制程序)
**配置文件**：`config.ini` (支持双设备和双机械臂配置)
**详细说明**：请参考 `双设备控制说明.md`

---

## 原基础功能概述 (仍然支持)

这是一个基于OpenHaptics的双Touch设备控制器程序，可以同时加载和控制两台Touch设备，读取设备位置、按钮状态，并提供力反馈输出。

## 功能特性

- ✅ 同时加载两台Touch设备
- ✅ 实时读取设备位置和按钮状态
- ✅ 提供力反馈输出
- ✅ 实时状态显示
- ✅ 多线程架构
- ✅ 错误处理和资源清理

## 编译要求

### 系统要求
- Linux系统
- OpenHaptics 3.4.0开发版
- GCC 4.8+ 或 Clang 3.3+
- pthread库

### 依赖库
- OpenHaptics HD库
- OpenHaptics HDU库
- pthread库

## 编译步骤

1. **确保OpenHaptics已安装**
   ```bash
   # 检查OpenHaptics库文件是否存在
   ls OpenHaptics/openhaptics_3.4-0-developer-edition-amd64/usr/lib/
   ```

2. **编译程序**
   ```bash
   make
   ```

3. **运行程序**
   ```bash
   make run
   ```

## 设备配置

### 设备名称配置
程序使用以下设备配置名称：
- `"PHANToM 1"` - 第一个设备
- `"PHANToM 2"` - 第二个设备

### 设备配置要求
确保系统中有对应的设备配置文件。如果没有，可能需要：
1. 使用Touch_Setup工具配置设备
2. 或者修改代码中的设备名称

## 程序功能

### 主要功能
1. **设备初始化**
   - 自动检测和初始化两台Touch设备
   - 启用力反馈输出
   - 启动调度器

2. **数据读取**
   - 实时读取设备位置 (X, Y, Z)
   - 读取按钮状态
   - 计算设备速度

3. **力反馈控制**
   - 为每个设备独立设置力反馈
   - 支持3D力向量 (FX, FY, FZ)

4. **状态显示**
   - 实时显示两台设备的状态
   - 位置、按钮、力反馈信息
   - 连接状态监控

### 程序界面
程序运行时会显示实时状态界面：
```
=== 双Touch设备控制器 ===

设备1状态:
  位置: (123.45, 67.89, 12.34) mm
  按钮: [0, 1]
  力反馈: (0.10, 0.00, 0.00) N
  连接状态: 已连接

设备2状态:
  位置: (-45.67, 89.12, 34.56) mm
  按钮: [1, 0]
  力反馈: (-0.10, 0.00, 0.00) N
  连接状态: 已连接

按 'q' 退出程序
```

## 使用方法

### 基本使用
1. **启动程序**
   ```bash
   ./dual_touch_simple
   ```

2. **操作设备**
   - 移动Touch设备手柄查看位置变化
   - 按下设备按钮查看按钮状态
   - 观察力反馈效果

3. **退出程序**
   - 按 'q' 键退出程序

### 力反馈测试
程序会自动进行力反馈测试：
- 设备1：轻微向右的力 (0.1N)
- 设备2：轻微向左的力 (-0.1N)

## 故障排除

### 常见问题

1. **设备初始化失败**
   ```
   初始化第一个设备失败: PHANToM 1
   错误代码: 1001
   ```
   **解决方案：**
   - 检查设备是否正确连接
   - 确认设备驱动已安装
   - 检查设备配置名称是否正确

2. **库文件找不到**
   ```
   /usr/bin/ld: cannot find -lHD
   ```
   **解决方案：**
   - 检查OpenHaptics库路径是否正确
   - 确认库文件存在
   - 检查Makefile中的路径设置

3. **权限问题**
   ```
   创建socket失败
   ```
   **解决方案：**
   - 确保有足够的权限访问设备
   - 检查udev规则设置

### 调试模式
使用调试模式编译可以获得更多信息：
```bash
make debug
./dual_touch_simple
```

## 代码结构

### 主要文件
- `dual_touch_simple.cpp` - 主程序文件
- `Makefile` - 编译配置文件

### 关键函数
- `initHapticDevices()` - 初始化触觉设备
- `DualTouchCallback()` - 主回调函数
- `setForce()` - 设置力反馈
- `displayDeviceStatus()` - 显示设备状态
- `cleanup()` - 资源清理

### 数据结构
```cpp
struct TouchDeviceData {
    hduVector3Dd position;      // 位置 (X, Y, Z) mm
    int buttons[2];             // 按钮状态 (0/1)
    hduVector3Dd force;         // 力反馈 (FX, FY, FZ) N
    bool is_connected;          // 连接状态
};
```

## 扩展功能

### 可以添加的功能
1. **网络通信**
   - 与机械臂通信
   - 远程控制接口

2. **高级力反馈**
   - 虚拟环境力反馈
   - 碰撞检测

3. **数据记录**
   - 设备数据记录
   - 性能分析

4. **图形界面**
   - 3D可视化
   - 实时轨迹显示

## 注意事项

1. **设备安全**
   - 确保设备在安全范围内移动
   - 避免过大的力反馈设置

2. **资源管理**
   - 程序会自动清理资源
   - 异常退出时也会进行清理

3. **性能考虑**
   - 回调函数频率较高，避免复杂计算
   - 使用线程安全的数据访问

## 技术支持

如果遇到问题，请检查：
1. OpenHaptics安装是否正确
2. 设备驱动是否正常
3. 设备配置是否正确
4. 系统权限是否足够

## 版本信息

- 版本：1.0
- 基于：OpenHaptics 3.4.0
- 支持：双Touch设备
- 平台：Linux 